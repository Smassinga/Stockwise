// src/lib/i18n.tsx
import React, { createContext, useContext, useEffect, useMemo, useState } from 'react'

export type Locale = 'en' | 'pt'
type Dict = Record<string, string>
type Bundle = Record<Locale, Dict>

const dict: Bundle = {
  en: {
    // ===== Common
    'none': '(none)',
    'common.headsUp': 'Heads up',
    'common.dash': '—',

    // ===== Window quick labels
    'window.30': 'Last 30 days',
    'window.60': 'Last 60 days',
    'window.90': 'Last 90 days',
    'window.180': 'Last 180 days',

    // ===== Settings (already working)
    'settings.title': 'Settings',
    'settings.subtitle': 'Configure your StockWise system',
    'actions.save': 'Save changes',
    'actions.saving': 'Saving…',

    'sections.users.title': 'Users',
    'sections.users.desc': 'Manage user accounts and roles.',
    'sections.users.button': 'Configure Users',

    'sections.warehouses.title': 'Warehouses',
    'sections.warehouses.desc': 'Define storage locations and bins.',
    'sections.warehouses.button': 'Manage Warehouses',

    'sections.uom.title': 'Units of Measure',
    'sections.uom.desc': 'Set up base and alternate UoMs.',
    'sections.uom.button': 'Setup UoM',

    'sections.localization.title': 'Localization & UI',
    'fields.language': 'Language',
    'fields.dashboardWindow': 'Default Dashboard Window',
    'fields.defaultWarehouse': 'Default Warehouse (Dashboard/Filters)',
    'fields.hideZeros': 'Hide zero totals on dashboard',

    'sections.sales.title': 'Sales & Fulfilment',
    'fields.allowLineShip': 'Allow ship-by-line (partial shipments)',
    'fields.autoCompleteWhenShipped': 'Auto-complete SO when all lines shipped',
    'fields.revenueRule': 'Revenue rule',
    'fields.revenueRule.order_total_first': 'Order total × FX, fallback lines',
    'fields.revenueRule.lines_only': 'Sum of lines only',
    'fields.allocateMissingRevenueBy': 'Allocate missing revenue by',
    'fields.allocateMissingRevenueBy.cogs_share': 'COGS share (issues)',
    'fields.allocateMissingRevenueBy.line_share': 'Line revenue share',
    'fields.defaultFulfilWarehouse': 'Default Fulfilment Warehouse',

    'sections.notifications.title': 'Notifications',
    'fields.lowStockChannel': 'Low stock channel',
    'fields.dailyDigest': 'Daily performance digest',

    'sections.documents.title': 'Documents & Templates',
    'fields.companyName': 'Company Name',
    'fields.logoUrl': 'Logo URL',
    'fields.packingSlipShowsPrices': 'Show prices on packing slips',

    'more.title': 'More coming soon',
    'more.body': 'Currency & tax, integrations, number sequences, imports/exports, and audit log.',

    // ===== Dashboard
    'dashboard.title': 'Dashboard',

    'filters.window.label': 'Window',
    'filters.warehouse.label': 'Warehouse',
    'filters.warehouse.all': 'All Warehouses',

    'daily.button': 'Daily Revenue & COGS',
    'daily.title': 'Daily Revenue & COGS',
    'daily.desc': 'Daily totals for the selected window',

    'table.date': 'Date',
    'table.item': 'Item',
    'table.sku': 'SKU',
    'table.onHand': 'On Hand',
    'table.minStock': 'Min Stock',
    'table.revenue': 'Revenue',
    'table.cogs': 'COGS',
    'table.grossMargin': 'Gross Margin',
    'table.gmPct': 'GM%',
    'table.type': 'Type',
    'table.qtyBase': 'Qty (base)',
    'table.value': 'Value',

    'kpi.inventoryValue.title': 'Inventory Value',
    'kpi.inventoryValue.help': 'Sum of (qty × avg_cost) across all warehouses.',
    'kpi.revenue.title': 'Revenue ({days}d)',
    'kpi.revenue.help': 'Finalized SOs use total_amount × FX; if missing, falls back to sum of remaining lines × FX.',
    'kpi.cogs.title': 'COGS ({days}d)',
    'kpi.cogs.help': 'Sales issues (ref_type = SO) in window.',
    'kpi.grossMargin.title': 'Gross Margin',
    'kpi.grossMargin.help_pct': 'of revenue',

    'lowStock.title': 'Low Stock',
    'lowStock.warehouseOnly': '(Warehouse only)',
    'lowStock.empty': 'No low stock items.',

    'topProducts.title': 'Top Products by Gross Margin ({days}d)',
    'topProducts.empty': 'No shipped sales in this window.',
    'topProducts.footnote':
      'Revenue attribution uses order total × FX when present. If lines are missing, revenue is allocated to items by the order’s SO-issue COGS shares; otherwise any difference between order total and line sums is spread across the order’s line items.',

    'recentMovements.title': 'Recent Movements',
    'recentMovements.empty': 'No recent movements.',

    'movement.receive': 'receive',
    'movement.issue': 'issue',
    'movement.transfer': 'transfer',
    'movement.adjust': 'adjust',

    // ===== Orders (existing)
    "orders.title":"Orders",
    "orders.purchaseTab":"Purchase",
    "orders.salesTab":"Sales",
    "orders.outstandingPOs":"Outstanding Purchase Orders",
    "orders.outstandingSOs":"Outstanding Sales Orders",
    "orders.newPO":"New PO",
    "orders.newSO":"New SO",
    "orders.createPO":"Create PO",
    "orders.createSO":"Create SO",
    "orders.po":"PO",
    "orders.so":"SO",
    "orders.actions":"Actions",
    "orders.status":"Status",
    "orders.currency":"Currency",
    "orders.total":"Total",
    "orders.view":"View",
    "orders.print":"Print",
    "orders.approve":"Approve",
    "orders.cancel":"Cancel",
    "orders.confirm":"Confirm",
    "orders.nothingPending":"Nothing pending.",
    "orders.noPOsYet":"No POs yet.",
    "orders.noSOsYet":"No SOs yet.",
    "orders.recentPOs":"Recent Purchase Orders",
    "orders.recentSOs":"Recent Sales Orders",

    "orders.supplier":"Supplier",
    "orders.customer":"Customer",
    "orders.selectSupplier":"Select supplier",
    "orders.selectCustomer":"Select customer",
    "orders.currencyShort":"Currency",
    "orders.fxToBase":"FX to Base ({code})",
    "orders.fxToBaseShort":"FX to Base",
    "orders.expectedDate":"Expected Date",
    "orders.expectedShip":"Expected Ship",
    "orders.lines":"Lines",
    "orders.item":"Item",
    "orders.uom":"UoM",
    "orders.qty":"Qty",
    "orders.unitPrice":"Unit Price",
    "orders.discountPct":"Disc %",
    "orders.lineTotal":"Line Total",
    "orders.addLine":"Add Line",
    "orders.taxPct":"Tax %",
    "orders.tax":"Tax",
    "orders.subtotal":"Subtotal",
    "orders.totalLabel":"Total",
    "orders.selectBin":"Select bin",
    "orders.toWarehouse":"To Warehouse",
    "orders.toBin":"To Bin",
    "orders.fromWarehouse":"From Warehouse",
    "orders.fromBin":"From Bin",
    "orders.receiveAll":"Receive All",
    "orders.shipAll":"Ship All",
    "orders.shipOrder":"Ship Order",
    "orders.ship":"Ship",
    "orders.onHandBin":"On-hand (bin)",
    "orders.binHint":"Bin Hint",
    "orders.action":"Action",
    "orders.noBin":"(no bin)",
    "orders.noStockInWh":"No stock in selected warehouse",

    "orders.popupBlocked":"Popup blocked",
    "orders.uomLoadFailed":"Could not load UoM conversions; conversions will be limited.",
    "orders.loadFailed":"Failed to load orders",
    "orders.supplierRequired":"Supplier is required",
    "orders.customerRequired":"Customer is required",
    "orders.addOneLine":"Add at least one valid line",
    "orders.insufficientStock":"Insufficient stock at source bin",
    "orders.insufficientStockBin":"Insufficient stock in bin for item {sku}",
    "orders.noConversion":"No conversion from {from} to base for {sku}",
    "orders.selectDestWh":"Select destination warehouse",
    "orders.selectDestBin":"Select destination bin",
    "orders.selectSourceWh":"Select source warehouse",
    "orders.selectSourceBin":"Select source bin",
    "orders.noLinesToReceive":"No lines to receive",
    "orders.noLinesToShip":"No lines to ship",
    "orders.poCreated":"Purchase Order created",
    "orders.poCreateFailed":"Failed to create PO",
    "orders.poApproved":"PO approved",
    "orders.poApproveFailed":"Failed to approve PO",
    "orders.poApproveSoftFail":"Could not set an approved-like status. Left as is.",
    "orders.poCancelled":"PO cancelled",
    "orders.poCancelFailed":"Failed to cancel PO",
    "orders.poCancelSoftFail":"Could not set a cancelled/canceled status. Left as is.",
    "orders.poReceived":"PO received",
    "orders.receiveFailed":"Failed to receive PO",
    "orders.lineShipped":"Line shipped",
    "orders.shipLineFailed":"Failed to ship line",
    "orders.shipSoFailed":"Failed to ship SO",

    "orders.poPrint.title":"Purchase Order",
    "orders.soPrint.title":"Sales Order",
    "orders.email":"Email",
    "orders.phone":"Phone",
    "orders.taxId":"Tax ID",
    "orders.paymentTerms":"Payment Terms",
    "orders.notes":"Notes",
    "orders.fxTo":"FX to {code}",
    "orders.qtyUom":"Qty (UoM)",
    "orders.lineValueBase":"Line Value (base)",
    "orders.poDetails":"PO Details",
    "orders.poDetailsDesc":"Review, select destination bin, and receive",
    "orders.noPOSelected":"No PO selected.",
    "orders.soDetails":"SO Details",
    "orders.soDetailsDesc":"Review, select source bin, and ship",
    "orders.noSOSelected":"No SO selected.",

    // ===== Movements (NEW)
    "movements.movementType":"Movement Type",
    "movements.title.bins":"Bins",
    "movements.bins.from":"From {name}",
    "movements.bins.to":"To {name}",
    "movements.noBins":"No bins.",
    "movements.title.binContents":"Bin Contents",
    "movements.pickBinToSee":"Pick a bin to see on-hand items.",
    "movements.onHandBase":"On Hand (base)",
    "movements.avgCost":"Avg Cost",
    "movements.card.receive":"Receive into Bin",
    "movements.card.issue":"Issue from Bin",
    "movements.card.transfer":"Transfer (Inter- or Intra-warehouse)",
    "movements.card.adjust":"Adjust Bin On-hand",
    "movements.selectItem":"Select item",
    "movements.pickFromBinFirst":"Pick From Bin first",
    "movements.pickToBinFirst":"Pick To Bin first",
    "movements.quantity":"Quantity",
    "movements.newOnHand":"New On-hand",
    "movements.preview.target":"Target",
    "movements.preview.entered":"Entered",
    "movements.preview.noPath":" (no conversion path; pick a convertible UoM)",
    "movements.movementUom":"Movement UoM",
    "movements.selectUom":"Select UoM",
    "movements.pickItemFirst":"Pick Item first",
    "movements.notConvertibleSuffix":" (not convertible)",
    "movements.unitCost":"Unit Cost",
    "movements.unitCost.requiredIfIncreasing":"(required if increasing)",
    "movements.refType":"Ref Type",
    "movements.refId":"Ref Id",
    "movements.refLineId":"Ref Line Id",
    "movements.refId.placeholder":"SO/PO id (optional)",
    "movements.refLineId.placeholder":"SOL/POL id (optional)",
    "movements.notes.placeholder":"Optional notes",
    "movements.emptyBin":"Empty bin.",
    "movements.uomLoadFailed":"Could not load UoM conversions; conversions limited.",
    "movements.loadFailed":"Failed to load data",
    "movements.loadFailedSourceWh":"Failed to load source warehouse",
    "movements.loadFailedDestWh":"Failed to load destination warehouse",
    "movements.selectItemRequired":"Select an item",
    "movements.qtyGtZero":"Quantity must be greater than zero",
    "movements.unitCostGteZero":"Unit Cost must be ≥ 0",
    "movements.noConversionToBase":"No conversion path to item base UoM",
    "movements.received":"Stock received",
    "movements.issued":"Stock issued",
    "movements.pickBothWh":"Pick both warehouses",
    "movements.pickBothBins":"Pick both bins",
    "movements.sameSourceDest":"Source and destination cannot be the same",
    "movements.transferCompleted":"Transfer completed",
    "movements.selectWhToAdjust":"Select warehouse to adjust",
    "movements.selectBinToAdjust":"Select bin to adjust",
    "movements.onHandCannotBeNegative":"New on-hand cannot be negative",
    "movements.noChange":"No change",
    "movements.unitCostRequiredForIncrease":"Unit Cost required (≥ 0) for positive adjustment",
    "movements.adjusted":"Stock adjusted",
    "movements.failed":"Movement failed",
    "movements.selectedUomNotConvertible":"Selected UoM cannot convert to the item base UoM",
    "movements.note.transferPrefix":"Transfer",
    "movements.note.adjust":"Adjust to {target} ({uom}) from {current} base",
    "movements.refType.SO":"SO (sales)",
    "movements.refType.PO":"PO (purchase)",

  },

  pt: {
    // ===== Common
    'none': '(nenhum)',
    'common.headsUp': 'Atenção',
    'common.dash': '—',

    // ===== Window quick labels
    'window.30': 'Últimos 30 dias',
    'window.60': 'Últimos 60 dias',
    'window.90': 'Últimos 90 dias',
    'window.180': 'Últimos 180 dias',

    // ===== Settings
    'settings.title': 'Configurações',
    'settings.subtitle': 'Configure o seu sistema StockWise',
    'actions.save': 'Salvar alterações',
    'actions.saving': 'Salvando…',

    'sections.users.title': 'Usuários',
    'sections.users.desc': 'Gerencie contas de usuários e papéis.',
    'sections.users.button': 'Configurar Usuários',

    'sections.warehouses.title': 'Armazéns',
    'sections.warehouses.desc': 'Defina locais de armazenamento e posições (bins).',
    'sections.warehouses.button': 'Gerenciar Armazéns',

    'sections.uom.title': 'Unidades de Medida',
    'sections.uom.desc': 'Configure UMs base e alternativas.',
    'sections.uom.button': 'Configurar UM',

    'sections.localization.title': 'Localização & Interface',
    'fields.language': 'Idioma',
    'fields.dashboardWindow': 'Janela padrão do painel',
    'fields.defaultWarehouse': 'Armazém padrão (Painel/Filtros)',
    'fields.hideZeros': 'Ocultar totais zero no painel',

    'sections.sales.title': 'Vendas & Atendimento',
    'fields.allowLineShip': 'Permitir envio por linha (parcial)',
    'fields.autoCompleteWhenShipped': 'Concluir PV quando todas as linhas forem enviadas',
    'fields.revenueRule': 'Regra de receita',
    'fields.revenueRule.order_total_first': 'Total do pedido × câmbio, fallback por linhas',
    'fields.revenueRule.lines_only': 'Somente soma das linhas',
    'fields.allocateMissingRevenueBy': 'Alocar receita faltante por',
    'fields.allocateMissingRevenueBy.cogs_share': 'Proporção do Custo (saídas)',
    'fields.allocateMissingRevenueBy.line_share': 'Proporção da receita por linha',
    'fields.defaultFulfilWarehouse': 'Armazém padrão de atendimento',

    'sections.notifications.title': 'Notificações',
    'fields.lowStockChannel': 'Canal de estoque baixo',
    'fields.dailyDigest': 'Resumo diário de performance',

    'sections.documents.title': 'Documentos & Modelos',
    'fields.companyName': 'Nome da empresa',
    'fields.logoUrl': 'URL do logotipo',
    'fields.packingSlipShowsPrices': 'Mostrar preços nas notas de embalagem',

    'more.title': 'Mais em breve',
    'more.body': 'Moeda e impostos, integrações, sequências numéricas, importações/exportações e log de auditoria.',

    // ===== Dashboard
    'dashboard.title': 'Painel',

    'filters.window.label': 'Período',
    'filters.warehouse.label': 'Armazém',
    'filters.warehouse.all': 'Todos os Armazéns',

    'daily.button': 'Receita & Custo Diário',
    'daily.title': 'Receita & Custo Diário',
    'daily.desc': 'Totais diários para o período selecionado',

    'table.date': 'Data',
    'table.item': 'Item',
    'table.sku': 'SKU',
    'table.onHand': 'Em Estoque',
    'table.minStock': 'Estoque Mínimo',
    'table.revenue': 'Receita',
    'table.cogs': 'Custo (COGS)',
    'table.grossMargin': 'Margem Bruta',
    'table.gmPct': 'MB%',
    'table.type': 'Tipo',
    'table.qtyBase': 'Qtd (base)',
    'table.value': 'Valor',

    'kpi.inventoryValue.title': 'Valor de Estoque',
    'kpi.inventoryValue.help': 'Soma de (qtd × custo médio) em todos os armazéns.',
    'kpi.revenue.title': 'Receita ({days}d)',
    'kpi.revenue.help': 'Pedidos finalizados usam total × câmbio; se ausente, usa a soma das linhas restantes × câmbio.',
    'kpi.cogs.title': 'COGS ({days}d)',
    'kpi.cogs.help': 'Saídas de venda (ref_type = SO) no período.',
    'kpi.grossMargin.title': 'Margem Bruta',
    'kpi.grossMargin.help_pct': 'da receita',

    'lowStock.title': 'Estoque Baixo',
    'lowStock.warehouseOnly': '(Apenas do armazém)',
    'lowStock.empty': 'Nenhum item com estoque baixo.',

    'topProducts.title': 'Top Produtos por Margem Bruta ({days}d)',
    'topProducts.empty': 'Sem vendas expedidas neste período.',
    'topProducts.footnote':
      'A atribuição de receita usa total do pedido × câmbio quando disponível. Se faltarem linhas, a receita é alocada pelos percentuais de COGS das saídas da venda; caso contrário, a diferença entre o total e a soma das linhas é distribuída entre os itens do pedido.',

    'recentMovements.title': 'Movimentos Recentes',
    'recentMovements.empty': 'Nenhum movimento recente.',

    'movement.receive': 'entrada',
    'movement.issue': 'saída',
    'movement.transfer': 'transferência',
    'movement.adjust': 'ajuste',

    // ===== Orders (existing)
    "orders.title":"Pedidos",
    "orders.purchaseTab":"Compras",
    "orders.salesTab":"Vendas",
    "orders.outstandingPOs":"Ordens de Compra Pendentes",
    "orders.outstandingSOs":"Pedidos de Venda Pendentes",
    "orders.newPO":"Nova OC",
    "orders.newSO":"Novo PV",
    "orders.createPO":"Criar OC",
    "orders.createSO":"Criar PV",
    "orders.po":"OC",
    "orders.so":"PV",
    "orders.actions":"Ações",
    "orders.status":"Status",
    "orders.currency":"Moeda",
    "orders.total":"Total",
    "orders.view":"Ver",
    "orders.print":"Imprimir",
    "orders.approve":"Aprovar",
    "orders.cancel":"Cancelar",
    "orders.confirm":"Confirmar",
    "orders.nothingPending":"Nada pendente.",
    "orders.noPOsYet":"Sem OCs ainda.",
    "orders.noSOsYet":"Sem PVs ainda.",
    "orders.recentPOs":"Ordens de Compra Recentes",
    "orders.recentSOs":"Pedidos de Venda Recentes",

    "orders.supplier":"Fornecedor",
    "orders.customer":"Cliente",
    "orders.selectSupplier":"Selecione o fornecedor",
    "orders.selectCustomer":"Selecione o cliente",
    "orders.fxToBase":"Câmbio p/ Base ({code})",
    "orders.fxToBaseShort":"Câmbio p/ Base",
    "orders.expectedDate":"Data Prevista",
    "orders.expectedShip":"Envio Previsto",
    "orders.lines":"Linhas",
    "orders.item":"Item",
    "orders.uom":"UM",
    "orders.qty":"Qtd",
    "orders.unitPrice":"Preço Unit.",
    "orders.discountPct":"Desc %",
    "orders.lineTotal":"Total da Linha",
    "orders.addLine":"Adicionar Linha",
    "orders.taxPct":"Imposto %",
    "orders.tax":"Imposto",
    "orders.subtotal":"Subtotal",
    "orders.totalLabel":"Total",
    "orders.selectBin":"Selecione o bin",
    "orders.toWarehouse":"Para Armazém",
    "orders.toBin":"Para Bin",
    "orders.fromWarehouse":"Do Armazém",
    "orders.fromBin":"Do Bin",
    "orders.receiveAll":"Dar Entrada",
    "orders.shipAll":"Expedir Tudo",
    "orders.shipOrder":"Expedir Pedido",
    "orders.ship":"Expedir",
    "orders.onHandBin":"Em estoque (bin)",
    "orders.binHint":"Sugestão de Bin",
    "orders.action":"Ação",
    "orders.noBin":"(sem bin)",
    "orders.noStockInWh":"Sem estoque no armazém selecionado",

    "orders.popupBlocked":"Popup bloqueado",
    "orders.uomLoadFailed":"Não foi possível carregar conversões de UM; conversões limitadas.",
    "orders.loadFailed":"Falha ao carregar pedidos",
    "orders.supplierRequired":"Fornecedor é obrigatório",
    "orders.customerRequired":"Cliente é obrigatório",
    "orders.addOneLine":"Adicione ao menos uma linha válida",
    "orders.insufficientStock":"Estoque insuficiente no bin de origem",
    "orders.insufficientStockBin":"Estoque insuficiente no bin para o item {sku}",
    "orders.noConversion":"Sem conversão de {from} para a base para {sku}",
    "orders.selectDestWh":"Selecione armazém de destino",
    "orders.selectDestBin":"Selecione bin de destino",
    "orders.selectSourceWh":"Selecione armazém de origem",
    "orders.selectSourceBin":"Selecione bin de origem",
    "orders.noLinesToReceive":"Sem linhas para dar entrada",
    "orders.noLinesToShip":"Sem linhas para expedir",
    "orders.poCreated":"Ordem de Compra criada",
    "orders.poCreateFailed":"Falha ao criar OC",
    "orders.poApproved":"OC aprovada",
    "orders.poApproveFailed":"Falha ao aprovar OC",
    "orders.poApproveSoftFail":"Não foi possível definir um status de aprovado. Mantido como está.",
    "orders.poCancelled":"OC cancelada",
    "orders.poCancelFailed":"Falha ao cancelar OC",
    "orders.poCancelSoftFail":"Não foi possível definir status cancelado/canceled. Mantido como está.",
    "orders.poReceived":"Entrada registrada para OC",
    "orders.receiveFailed":"Falha ao registrar entrada",
    "orders.lineShipped":"Linha expedida",
    "orders.shipLineFailed":"Falha ao expedir linha",
    "orders.shipSoFailed":"Falha ao expedir PV",

    "orders.poPrint.title":"Ordem de Compra",
    "orders.soPrint.title":"Pedido de Venda",
    "orders.email":"Email",
    "orders.phone":"Telefone",
    "orders.taxId":"NIF",
    "orders.paymentTerms":"Condições de Pagamento",
    "orders.notes":"Observações",
    "orders.fxTo":"Câmbio p/ {code}",
    "orders.qtyUom":"Qtd (UM)",
    "orders.lineValueBase":"Valor da Linha (base)",
    "orders.poDetails":"Detalhes da OC",
    "orders.poDetailsDesc":"Revise, selecione o bin de destino e dê entrada",
    "orders.noPOSelected":"Nenhuma OC selecionada.",
    "orders.soDetails":"Detalhes do PV",
    "orders.soDetailsDesc":"Revise, selecione o bin de origem e expedir",
    "orders.noSOSelected":"Nenhum PV selecionado.",

    // ===== Movements (NOVO)
    "movements.movementType":"Tipo de Movimento",
    "movements.title.bins":"Bins",
    "movements.bins.from":"De {name}",
    "movements.bins.to":"Para {name}",
    "movements.noBins":"Sem bins.",
    "movements.title.binContents":"Conteúdo do Bin",
    "movements.pickBinToSee":"Selecione um bin para ver o estoque disponível.",
    "movements.onHandBase":"Em estoque (base)",
    "movements.avgCost":"Custo Médio",
    "movements.card.receive":"Dar Entrada no Bin",
    "movements.card.issue":"Dar Saída do Bin",
    "movements.card.transfer":"Transferência (Inter ou Intra-armazém)",
    "movements.card.adjust":"Ajustar Quantidade do Bin",
    "movements.selectItem":"Selecione o item",
    "movements.pickFromBinFirst":"Selecione o Bin de Origem primeiro",
    "movements.pickToBinFirst":"Selecione o Bin de Destino primeiro",
    "movements.quantity":"Quantidade",
    "movements.newOnHand":"Novo Em Estoque",
    "movements.preview.target":"Destino",
    "movements.preview.entered":"Digitado",
    "movements.preview.noPath":" (sem rota de conversão; escolha uma UM convertível)",
    "movements.movementUom":"UM do Movimento",
    "movements.selectUom":"Selecione a UM",
    "movements.pickItemFirst":"Selecione o Item primeiro",
    "movements.notConvertibleSuffix":" (não convertível)",
    "movements.unitCost":"Custo Unitário",
    "movements.unitCost.requiredIfIncreasing":"(obrigatório se aumentar)",
    "movements.refType":"Tipo de Ref",
    "movements.refId":"ID de Ref",
    "movements.refLineId":"ID da Linha Ref",
    "movements.refId.placeholder":"ID de SO/PO (opcional)",
    "movements.refLineId.placeholder":"ID de SOL/POL (opcional)",
    "movements.notes.placeholder":"Observações (opcional)",
    "movements.emptyBin":"Bin vazio.",
    "movements.uomLoadFailed":"Não foi possível carregar conversões de UM; conversões limitadas.",
    "movements.loadFailed":"Falha ao carregar dados",
    "movements.loadFailedSourceWh":"Falha ao carregar armazém de origem",
    "movements.loadFailedDestWh":"Falha ao carregar armazém de destino",
    "movements.selectItemRequired":"Selecione um item",
    "movements.qtyGtZero":"A quantidade deve ser maior que zero",
    "movements.unitCostGteZero":"Custo Unitário deve ser ≥ 0",
    "movements.noConversionToBase":"Sem rota de conversão para a UM base do item",
    "movements.received":"Entrada registrada",
    "movements.issued":"Saída registrada",
    "movements.pickBothWh":"Selecione ambos os armazéns",
    "movements.pickBothBins":"Selecione ambos os bins",
    "movements.sameSourceDest":"Origem e destino não podem ser iguais",
    "movements.transferCompleted":"Transferência concluída",
    "movements.selectWhToAdjust":"Selecione o armazém para ajustar",
    "movements.selectBinToAdjust":"Selecione o bin para ajustar",
    "movements.onHandCannotBeNegative":"Novo estoque não pode ser negativo",
    "movements.noChange":"Sem alterações",
    "movements.unitCostRequiredForIncrease":"Custo Unitário obrigatório (≥ 0) para ajuste positivo",
    "movements.adjusted":"Estoque ajustado",
    "movements.failed":"Falha no movimento",
    "movements.selectedUomNotConvertible":"UM selecionada não converte para a UM base do item",
    "movements.note.transferPrefix":"Transferência",
    "movements.note.adjust":"Ajustar para {target} ({uom}) a partir de {current} base",
    "movements.refType.SO":"SO (vendas)",
    "movements.refType.PO":"PO (compras)",
  },
}

type Ctx = {
  lang: Locale
  t: (key: string, vars?: Record<string, string | number>) => string
  setLang: (next: Locale) => void
}

const I18nContext = createContext<Ctx>({
  lang: 'en',
  t: (k: string) => k,
  setLang: () => {},
})

export function I18nProvider({ children }: { children: React.ReactNode }) {
  const [lang, setLang] = useState<Locale>(() => {
    const fromLS = localStorage.getItem('app:lang') as Locale | null
    return fromLS === 'pt' ? 'pt' : 'en'
  })

  useEffect(() => {
    localStorage.setItem('app:lang', lang)
    document.documentElement.setAttribute('lang', lang)
  }, [lang])

  const t = useMemo(
    () => (key: string, vars?: Record<string, string | number>) => {
      let s = dict[lang]?.[key] ?? dict.en[key] ?? key
      if (vars) for (const [k, v] of Object.entries(vars)) s = s.replace(`{${k}}`, String(v))
      return s
    },
    [lang]
  )

  const value = useMemo<Ctx>(() => ({ lang, setLang, t }), [lang, t])
  return <I18nContext.Provider value={value}>{children}</I18nContext.Provider>
}

export function useI18n() {
  return useContext(I18nContext)
}
