{
  "intent": "Runbook: Daily Digest pipeline setup & health",
  "actor": "chatgpt",
  "idempotency_key": "runbook-digest-pipeline-v1b",
  "commands": [
    {
      "label": "insert digest runbook",
      "sql": "insert into ops.runbooks(topic, doc) values ('daily_digest_pipeline', jsonb_build_object( 'db_objects', jsonb_build_object( 'tables', jsonb_build_array('public.digest_queue','public.company_digest_state','private.app_secrets'), 'functions', jsonb_build_array('public.process_daily_digests()','public.build_daily_digest_payload(uuid,date,text)','app.call_digest_worker(jsonb)') ), 'secrets', jsonb_build_object( 'hook_secret_source', 'private.app_secrets.DIGEST_FN_KEY', 'edge_env', jsonb_build_array('DIGEST_HOOK_SECRET','SENDGRID_API_KEY','FROM_EMAIL','REPLY_TO_EMAIL','BRAND_NAME','SERVICE_ROLE_KEY') ), 'crons', jsonb_build_array( jsonb_build_object('name','queue_daily_digests','schedule','*/5 * * * *','command','select public.process_daily_digests();'), jsonb_build_object('name','run_digest_worker','schedule','*/2 * * * *','command','select app.call_digest_worker();') ), 'email_stack', jsonb_build_object( 'sendgrid', jsonb_build_object('domain_auth','em1179.stockwiseapp.com','link_branding','links.stockwiseapp.com','open_click_tracking','enabled'), 'dns', jsonb_build_object('spf','v=spf1 include:sendgrid.net include:spf.improvmx.com ~all','dmarc','v=DMARC1; p=none; rua=mailto:dmarc@stockwiseapp.com; fo=1; pct=100; adkim=s; aspf=s') ), 'health_sql', jsonb_build_object( 'crons', 'select jobid,jobname,schedule,command from cron.job where jobname in (''queue_daily_digests'',''run_digest_worker'') order by jobname;', 'queue_head', 'select id,company_id,status,created_at,processed_at from public.digest_queue order by id desc limit 10;', 'state', 'select company_id,last_status,last_error,last_attempt_at,last_digest_local_date from public.company_digest_state order by last_attempt_at desc limit 10;' ) ));"
    }
  ]
}
